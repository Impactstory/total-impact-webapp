function Genre(e){this.name=e;this.items=[];this.sortItems=function(e){return _.sortBy(e,function(e){var t=_.reduce(e.dict.awards,function(e,t){return e+(t.isHighly?10:1)},0);return t}).reverse()};this.render=function(){this.items=this.sortItems(this.items);var e=$(ich.genreTemplate({name:this.name},!0)),t=[],n=[];for(var r=0;r<this.items.length;r++){var i=this.items[r];i.dict.awards.length?t.push(i.render()):n.push(i.render())}e.find("ul.items.active").append(t);e.find("ul.items.inactive").append(n);n.length?e.find("h4.plus-more").toggle(function(){$(this).addClass("showing").siblings("ul.items.inactive").slideDown();$(this).find("span.show-hide").html("(hide)")},function(){$(this).removeClass("showing").siblings("ul.items.inactive").slideUp();$(this).find("span.show-hide").html("(show)")}).find("span.value").html(n.length):e.find("h4.plus-more").hide();return e};return!0}function GenreList(e){var t=_.groupBy(e,function(e){return e.dict.biblio.genre});this.genres=_.map(t,function(e,t){var n=new Genre(t);n.items=e;return n});this.render=function(){var e=_.chain(this.genres).sortBy("name").map(function(e){return e.render()}).value();$("div.genre").remove();$("div.tooltip").remove();$("#metrics div.wrapper").append(e)}}function Coll(e,t){this.views=e;this.user=t;this.id=null;this.items={};this.addItemsFromDicts=function(e,t){for(var n=0;n<e.length;n++){tiid=e[n]._id;this.items[tiid]=new Item(e[n],new ItemView($),$);console.log(e[n])}};this.create=function(e,t){var n=this,r={aliases:e,title:t};console.log("making the collection now.");$.ajax({url:"http://"+api_root+"/collection",type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(r),success:function(e){console.log("finished making the collection!");var t=e.collection._id,r=function(){location.href="/collection/"+t};n.user.addColl(t,e.key);n.user.syncWithServer("push",{on200:r,onNoUserId:r})}})};this.read=function(e,t){if(t===undefined)var t=0;var n=this;this.views.startUpdating();$.ajax({url:"http://"+api_root+"/v1/collection/"+n.id+"?key="+api_key,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",statusCode:{210:function(r){console.log("still updating");n.title=r.title;n.itemIds=r.alias_tiids;n.addItemsFromDicts(r.items);n.render.call(n);t>120?console.log("failed to finish update; giving up after 1min."):setTimeout(function(){n.read(e,t+1)},500)},200:function(e){console.log("done with updating");n.itemIds=e.alias_tiids;n.title=e.title;n.addItemsFromDicts(e.items);n.render.call(n);return!1}}})};this.updateTitle=function(e){};this.addItems=function(e){};this.deleteItem=function(e){};this.update=function(e,t,n){if(!this.isEditable())return!1;this.itemIds=e;this.title=t;var r={title:t,alias_tiids:e},i="http://"+api_root+"/v1/collection/"+this.id+"?key="+api_key+"&edit_key="+edit_key,s=this;$.ajax({url:i,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(requestObj),success:function(e){console.log("finished updating the collection!");n()}})};this.refreshItemData=function(){var e=this;this.views.startUpdating();$.ajax({url:"http://"+api_root+"/v1/collection/"+this.id+"?key="+api_key,type:"POST",success:function(t){console.log("updating.");e.read(1e3)}})};this.render=function(){this.views.renderIsEditable(this.isEditable());this.views.renderItems(this.items);this.views.finishUpdating(this.items)};this.isEditable=function(){return!!this.user.getKeyForColl(this.id)}}function CollViews(){this.startUpdating=function(){$("img.loading").remove();$("h2").before(ajaxLoadImg)};this.badgesWeight=function(e){return _.reduce(e.awards,function(e,t){return e+t.isHighly?10:1},0)};this.finishUpdating=function(e){$("#page-header img").remove();$("#num-items span.value").text(e.length);$("ul.active li.item div.item-header").addClass("zoomable");$("span.item-expand-button").show().css({color:tiLinkColor}).fadeOut(1500,function(){$(this).removeAttr("style")})};this.renderItems=function(e){var t=_.values(e),n=new GenreList(t);n.render()};this.renderIsEditable=function(e){e&&$("div#report").addClass("editable")}}function CollController(e,t){this.collReportPageInit=function(){e.id=reportId;e.render();e.read(1e3)};$("#update-report-button").click(function(){e.refreshItemData();return!1});$("div#num-items a").toggle(function(){$(this).html("(collapse all)");$("li.item").addClass("zoomed").find("div.zoom").show()},function(){$(this).html("(expand all)");$("li.item").removeClass("zoomed").find("div.zoom").hide()})};